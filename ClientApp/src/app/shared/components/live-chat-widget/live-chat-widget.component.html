<!-- Chat Widget Button -->
<div class="chat-widget-container">
  <!-- Chat Toggle Button -->
  <button
    class="chat-toggle-btn"
    (click)="toggleChat()"
    [class.unread]="messages.length > 3"
    [attr.aria-label]="isOpen ? 'Close chat' : 'Open chat'"
    type="button">
    <svg *ngIf="!isOpen" class="chat-icon" fill="currentColor" viewBox="0 0 24 24">
      <path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"/>
    </svg>
    <svg *ngIf="isOpen && !isMinimized" class="chat-icon" fill="currentColor" viewBox="0 0 24 24">
      <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
    </svg>
    <svg *ngIf="isOpen && isMinimized" class="chat-icon" fill="currentColor" viewBox="0 0 24 24">
      <path d="M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z"/>
    </svg>
  </button>

  <!-- Chat Window -->
  <div class="chat-window" [class.open]="isOpen" [class.minimized]="isMinimized">
    <!-- Chat Header -->
    <div class="chat-header">
      <div class="chat-header-info">
        <div class="support-avatar">
          <svg fill="currentColor" viewBox="0 0 24 24">
            <path d="M12 2C13.1 2 14 2.9 14 4C14 5.1 13.1 6 12 6C10.9 6 10 5.1 10 4C10 2.9 10.9 2 12 2ZM21 9V7L15 1H5C3.89 1 3 1.89 3 3V21C3 22.11 3.89 23 5 23H19C20.11 23 21 22.11 21 21V9M19 9H14V4H19V9Z"/>
          </svg>
        </div>
        <div class="support-info">
          <div class="support-name">Community Car Support</div>
          <div class="support-status">
            <span class="status-dot"></span>
            Online
          </div>
        </div>
      </div>
      <div class="chat-controls">
        <button
          class="control-btn minimize-btn"
          (click)="minimizeChat()"
          [attr.aria-label]="'Minimize chat'"
          type="button">
          <svg fill="currentColor" viewBox="0 0 24 24">
            <path d="M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z"/>
          </svg>
        </button>
        <button
          class="control-btn close-btn"
          (click)="closeChat()"
          [attr.aria-label]="'Close chat'"
          type="button">
          <svg fill="currentColor" viewBox="0 0 24 24">
            <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
          </svg>
        </button>
      </div>
    </div>

    <!-- Chat Messages -->
    <div class="chat-messages" #messagesContainer>
      <div
        *ngFor="let message of messages; trackBy: trackByMessageId"
        class="message"
        [ngClass]="{'user-message': message.sender === 'user', 'support-message': message.sender === 'support'}">
        <div class="message-content">
          <div class="message-text">{{ message.text }}</div>
          <div class="message-time">{{ getMessageTime(message.timestamp) }}</div>
        </div>
      </div>

      <!-- Typing Indicator -->
      <div *ngIf="isTyping" class="message support-message typing-indicator">
        <div class="message-content">
          <div class="typing-dots">
            <span></span>
            <span></span>
            <span></span>
          </div>
        </div>
      </div>
    </div>

    <!-- Chat Input -->
    <div class="chat-input-container">
      <div class="chat-input-wrapper">
        <textarea
          class="chat-input"
          [(ngModel)]="newMessage"
          (keydown)="onKeyPress($event)"
          placeholder="Type your message..."
          rows="1"
          maxlength="500"
          #messageInput></textarea>
        <button
          class="send-btn"
          (click)="sendMessage()"
          [disabled]="!newMessage.trim()"
          [attr.aria-label]="'Send message'"
          type="button">
          <svg fill="currentColor" viewBox="0 0 24 24">
            <path d="M2 21L23 12 2 3 2 10 17 12 2 14 2 21Z"/>
          </svg>
        </button>
      </div>
      <div class="chat-footer">
        <span class="chat-disclaimer">We typically respond within 5 minutes</span>
      </div>
    </div>
  </div>
</div>
